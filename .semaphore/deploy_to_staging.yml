version: v1.0
name: Deploy to Staging
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

auto_cancel:
  running:
    when: 'true'

global_job_config:
  prologue:
    commands:
      - sudo pip install awscli
      - checkout
  env_vars:
    - name: ENV
      value: staging
    - name: PYTHONPATH
      value: /app

blocks:
  - name: Build Docker Image
    dependencies: []
    task:
      jobs:
        - name: Docker Build
          commands:
            - docker build -t missing_trees .

  - name: Deploy Lambda Function
    dependencies:
      - Build Docker Image
    run:
      when: branch = 'main'
    task:
      secrets:
        - name: AWS Personal
      prologue:
        commands:
          - mv .env.sample .env
      jobs:
        - name: Deploy via AWS CLI
          commands:
            - >
              docker run --rm -v "$PWD":/app -w /app -e PYTHONPATH=/app
              -e AWS_ACCESS_KEY_ID -e AWS_SECRET_KEY -e AWS_DEFAULT_REGION
              missing_trees bash -c "python scripts/deploy_lambda.py --env staging"
          matrix:
            - env_var: AWS_REGION
              values:
                - af-south-1
            - env_var: AWS_ACCOUNT
              values:
                - '141080742224'

# promotions:
#   - name: Promote to production
#     pipeline_file: deploy_to_production.yml
