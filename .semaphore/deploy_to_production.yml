version: v1.0
name: Deploy to production
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
auto_cancel:
  running:
    when: 'true'
global_job_config:
  prologue:
    commands:
      - sudo pip install awscli
      - checkout
  env_vars:
    - name: NODE_ENV
      value: production
blocks:
  - name: Setup dependencies
    dependencies: []
    task:
      jobs:
        - name: Install and store
          commands:
            - npm ci
            - cache store
  # becca-playground-application lambda
  - name: Deploy becca-playground-application function
    dependencies:
      - Setup dependencies
    skip:
      when: branch != 'main'
    task:
      secrets:
        - name: AWS ProServices Sandbox
      prologue:
        commands:
          - cache restore
          - mv .env.sample .env
      jobs:
        - name: Deploy lambda function
          commands:
            - npm run deploy:production
          matrix:
            - env_var: AWS_REGION_VARIABLE_APP
              values:
                - af-south-1
            - env_var: AWS_ACCOUNT
              values:
                - 'REPLACE-WITH-ACCOUNT-NUMBER'
