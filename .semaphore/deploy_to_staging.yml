version: v1.0
name: Deploy to Staging
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

auto_cancel:
  running:
    when: 'true'

global_job_config:
  prologue:
    commands:
      - sudo pip install awscli
      - checkout
  env_vars:
    - name: ENV
      value: staging
    - name: PYTHONPATH
      value: /app

blocks:
  - name: Deploy Lambda Function
    # run:
    #   when: branch = 'main'
    task:
      secrets:
        - name: AWS Personal
      prologue:
        commands:
          - mv .env.sample .env
      jobs:
        - name: Deploy via Serverless CLI container
          commands:
            - docker build -t missing_trees .
            - >
              docker run --rm -v "$PWD":/app -w /app
              -e AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY -e AWS_DEFAULT_REGION=af-south-1
              -e SERVERLESS_ACCESS_TOKEN=$SERVERLESS_ACCESS_TOKEN
              serverless/serverless
              deploy --stage staging --verbose

# promotions:
#   - name: Promote to production
#     pipeline_file: deploy_to_production.yml